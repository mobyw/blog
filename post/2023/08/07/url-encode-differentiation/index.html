<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  

  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="cleartype" content="on">
<link rel="alternate" type="application/rss+xml" title="Xiaohei Terminal" href="/feed.xml" />
<link href="/static/theme/style.css" rel="stylesheet">


  
<title>不同高级语言的 URL 编码差异 - Xiaohei Terminal</title>
<link rel="stylesheet" href="/static/theme/railscasts.min.css">
<script src="/static/theme/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>

</head>

<body>
  

  <header class="header">
    <nav class="nav">
      <ul>
  <li><a href="/">首页</a></li>
  <li><a href="/about/index.html">关于</a></li>
  <li><a href="/links/index.html">链接</a></li>
  <li><a href="https://github.com/mobyw" target="_blank">GitHub</a></li>
  <li><a href="/feed.xml">RSS</a></li>
</ul>
    </nav>
  </header>
  <div class="body">
    
<main class="main page">
  <article class="article">
    <div class="title">
      <h1 class="title">不同高级语言的 URL 编码差异</h1>
    </div>
    
<div class="meta">
  
  <time class="created" datetime="2023-08-07">August  7, 2023</time>
  
</div>

    <div class="content">
      
      <details open>
        <summary>目录：</summary>
        <nav><ul>
<li><a href="#相关标准">相关标准</a></li>
<li><a href="#测试结果">测试结果</a></li>
<li><a href="#测试代码">测试代码</a></li>
</ul></nav>
      </details>
      <hr>
      

      <p>水群时看到有群友遇到了因 URL 对字符 <code>*</code> 的编码不符合预期问题导致的程序错误，便做此篇测试部分高级语言的 URL 编码实现有何不同。</p>
<h2><a id="相关标准" href="#相关标准" class="anchor"></a>相关标准</h2>
<p>由于 <a href="https://datatracker.ietf.org/doc/html/rfc1738">RFC 1738: Uniform Resource Locators (URL)</a> 并非互联网标准 (Internet Standard)，故本文参考互联网标准 <a href="https://datatracker.ietf.org/doc/html/rfc3986">RFC 3986: Uniform Resource Identifier (URI): Generic Syntax</a> 编写。该标准推荐使用通用术语 "URI"，而不是限制性更强的术语 "URL" 和 "URN" <a href="https://datatracker.ietf.org/doc/html/rfc3305">(RFC3305)</a>。</p>
<p>RFC 3986 对 URI 中非保留字符的定义如下：</p>
<pre class="highlight"><code class="language-text">unreserved  = ALPHA / DIGIT / &quot;-&quot; / &quot;.&quot; / &quot;_&quot; / &quot;~&quot;
</code></pre>

<p>在 URI 编码时，对于非保留字符 <code>unreserved</code> 应保持不进行转义，但是该标准同样说明了如果遇到了转义了这些字符的 URI 编码，在解码时仍需要将其恢复为原字符。</p>
<pre class="highlight"><code class="language-text">URIs that differ in the replacement of an unreserved character with
its corresponding percent-encoded US-ASCII octet are equivalent: they
identify the same resource.  However, URI comparison implementations
do not always perform normalization prior to comparison (see Section
6).  For consistency, percent-encoded octets in the ranges of ALPHA
(%41-%5A and %61-%7A), DIGIT (%30-%39), hyphen (%2D), period (%2E),
underscore (%5F), or tilde (%7E) should not be created by URI
producers and, when found in a URI, should be decoded to their
corresponding unreserved characters by URI normalizers.
</code></pre>

<p>该标准中同样指出了 <code>~</code> 字符在旧的 URI 编码实现中经常转义为 <code>%7E</code>。</p>
<pre class="highlight"><code class="language-text">For example, the octet
corresponding to the tilde (&quot;~&quot;) character is often encoded as &quot;%7E&quot;
by older URI processing implementations; the &quot;%7E&quot; can be replaced by
&quot;~&quot; without changing its interpretation.
</code></pre>

<p>对于可能需要转义的保留字符，该标准将其分为两类：</p>
<pre class="highlight"><code class="language-text">reserved    = gen-delims / sub-delims
gen-delims  = &quot;:&quot; / &quot;/&quot; / &quot;?&quot; / &quot;#&quot; / &quot;[&quot; / &quot;]&quot; / &quot;@&quot;
sub-delims  = &quot;!&quot; / &quot;$&quot; / &quot;&amp;&quot; / &quot;'&quot; / &quot;(&quot; / &quot;)&quot;
            / &quot;*&quot; / &quot;+&quot; / &quot;,&quot; / &quot;;&quot; / &quot;=&quot;
</code></pre>

<p>其中 <code>gen-delims</code> 和 URI 的结构相关，必须要进行转义，而 <code>sub-delims</code> 是否需要需要根据所在位置判断。特别地，由于转义使用 <code>%</code> 符号，所以 <code>%</code> 符号自身也需要进行转义。</p>
<p>典型的 URI 组成部分如下：</p>
<pre class="highlight"><code class="language-text">      foo://example.com:8042/over/there?name=ferret#nose
      \_/   \______________/\_________/ \_________/ \__/
       |           |            |            |        |
    scheme     authority       path        query   fragment
       |   _____________________|__
      / \ /                        \
      urn:example:animal:ferret:nose
</code></pre>

<p>与 <code>sub-delims</code> 相关的文法片段如下：</p>
<pre class="highlight"><code class="language-text">authority     = [ userinfo &quot;@&quot; ] host [ &quot;:&quot; port ]
userinfo      = *( unreserved / pct-encoded / sub-delims / &quot;:&quot; )

host          = IP-literal / IPv4address / reg-name
IP-literal    = &quot;[&quot; ( IPv6address / IPvFuture  ) &quot;]&quot;
IPvFuture     = &quot;v&quot; 1*HEXDIG &quot;.&quot; 1*( unreserved / sub-delims / &quot;:&quot; )
reg-name      = *( unreserved / pct-encoded / sub-delims )

path          = path-abempty    ; begins with &quot;/&quot; or is empty
              / path-absolute   ; begins with &quot;/&quot; but not &quot;//&quot;
              / path-noscheme   ; begins with a non-colon segment
              / path-rootless   ; begins with a segment
              / path-empty      ; zero characters
path-abempty  = *( &quot;/&quot; segment )
path-absolute = &quot;/&quot; [ segment-nz *( &quot;/&quot; segment ) ]
path-noscheme = segment-nz-nc *( &quot;/&quot; segment )
path-rootless = segment-nz *( &quot;/&quot; segment )
path-empty    = 0&lt;pchar&gt;
segment       = *pchar
segment-nz    = 1*pchar
segment-nz-nc = 1*( unreserved / pct-encoded / sub-delims / &quot;@&quot; )
              ; non-zero-length segment without any colon &quot;:&quot;
pchar         = unreserved / pct-encoded / sub-delims / &quot;:&quot; / &quot;@&quot;

query         = *( pchar / &quot;/&quot; / &quot;?&quot; )

fragment      = *( pchar / &quot;/&quot; / &quot;?&quot; )
</code></pre>

<p>如果按照以上文法推导，<code>sub-delims</code> 中的字符在 <code>authority</code> <code>path</code> <code>query</code> <code>fragment</code> 中均可能保持原样。</p>
<p>另外，空格字符在 <code>application/x-www-form-urlencoded</code> 类型中编码为 <code>+</code>，而在 RFC 3986 中的编码为 <code>%20</code>。</p>
<p>为找出不同高级语言对这些字符转义处理的差别，下面进行了一个简单的测试，先给出了测试结果，具体的测试代码及输出在最后给出。</p>
<h2><a id="测试结果" href="#测试结果" class="anchor"></a>测试结果</h2>
<p>仅测试了在 <code>query</code> 段中的编码和解码情况，在所有编码测试中，以 <code>sub-delims</code> 中的字符均已编码，<code>unreserved</code> 中的特殊字符均未编码为参考结果，标注与参考结果有差别的字符表，另外单列了对空格的转义情况。解码测试使用全部特殊字符转义的字符串，由于解码结果均相同，不额外展示在表格中。</p>
<table>
<thead>
<tr>
<th>语言</th>
<th>Module / Function</th>
<th style="text-align: center;"><code>sub-delims</code><br /> 未被转义</th>
<th style="text-align: center;"><code>unreserved</code> <br />被转义</th>
<th style="text-align: center;">SP 编码</th>
<th style="text-align: center;"><code>+</code> 解码</th>
</tr>
</thead>
<tbody>
<tr>
<td>Python 3</td>
<td><code>urllib.parse</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;">需使用 <code>unquote_plus</code></td>
</tr>
<tr>
<td>Go</td>
<td><code>net/url</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>Java</td>
<td><code>java.net.URLEncoder</code> <br /> <code>java.net.URLDecoder</code></td>
<td style="text-align: center;"><code>*</code></td>
<td style="text-align: center;"><code>~</code></td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>JavaScript</td>
<td><code>URLSearchParams</code></td>
<td style="text-align: center;"><code>*</code></td>
<td style="text-align: center;"><code>~</code></td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>JavaScript</td>
<td><code>encodeURIComponent</code><br /> <code>decodeURIComponent</code></td>
<td style="text-align: center;"><code>*</code></td>
<td style="text-align: center;"><code>~</code></td>
<td style="text-align: center;"><code>%20</code></td>
<td style="text-align: center;">无法解码 <code>+</code></td>
</tr>
<tr>
<td>Node.js</td>
<td><code>querystring</code></td>
<td style="text-align: center;"><code>!'()*</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>%20</code></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>C#</td>
<td><code>System.Net.WebUtility</code></td>
<td style="text-align: center;"><code>!()*</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>PHP</td>
<td><code>urlencode</code> <br /> <code>urldecode</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>~</code></td>
<td style="text-align: center;"><code>+</code></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>PHP</td>
<td><code>rawurlencode</code><br /> <code>rawurldecode</code></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"><code>%20</code></td>
<td style="text-align: center;">无法解码 <code>+</code></td>
</tr>
</tbody>
</table>
<p>虽然编码时对符号的转义处理不同，但是使用全部转义的 <code>sub-delims</code> 以及 <code>unreserved</code> 中的特殊字符进行测试时被测程序都能正确进行解码。</p>
<h2><a id="测试代码" href="#测试代码" class="anchor"></a>测试代码</h2>
<p>Python 3:</p>
<pre class="highlight"><code class="language-python">from urllib.parse import urlencode, unquote, unquote_plus

print(urlencode({&quot;param&quot;:&quot; !$&amp;'()*+,;=-._~&quot;}))
print(unquote(&quot;param=a+b&quot;))
print(unquote_plus(&quot;param=a+b&quot;))
</code></pre>

<pre class="highlight"><code class="language-text">param=+%21%24%26%27%28%29%2A%2B%2C%3B%3D-._~
param=a+b
param=a b
</code></pre>

<p>Go:</p>
<pre class="highlight"><code class="language-go">package main

import (
    &quot;fmt&quot;
    &quot;net/url&quot;
)

func main() {
    fmt.Println(url.QueryEscape(&quot; !$&amp;'()*+,;=-._~&quot;))
    fmt.Println(url.QueryUnescape(&quot;a+b&quot;))
}
</code></pre>

<pre class="highlight"><code class="language-text">+%21%24%26%27%28%29%2A%2B%2C%3B%3D-._~
a b &lt;nil&gt;
</code></pre>

<p>Java:</p>
<pre class="highlight"><code class="language-java">import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

public class Main {
    public static void main(String[] args) throws UnsupportedEncodingException {
        System.out.println(URLEncoder.encode(&quot; !$&amp;'()*+,;=-._~&quot;, StandardCharsets.UTF_8.toString()));
        System.out.println(URLDecoder.decode(&quot;a+b&quot;, StandardCharsets.UTF_8.toString()));
    }
}
</code></pre>

<pre class="highlight"><code class="language-text">+%21%24%26%27%28%29*%2B%2C%3B%3D-._%7E
a b
</code></pre>

<p>JavaScript:</p>
<pre class="highlight"><code class="language-js">const encode = new URLSearchParams();
encode.set(&quot;param&quot;, &quot; !$&amp;'()*+,;=-._~&quot;);
console.log(encode.toString());
const decode = new URLSearchParams(&quot;param=a+b&quot;);
console.log(decode.get(&quot;param&quot;));
console.log(encodeURIComponent(&quot; !$&amp;'()*+,;=-._~&quot;));
console.log(decodeURIComponent(&quot;a+b&quot;));
</code></pre>

<pre class="highlight"><code class="language-text">param=+%21%24%26%27%28%29*%2B%2C%3B%3D-._%7E
a b
%20!%24%26'()*%2B%2C%3B%3D-._~
a+b
</code></pre>

<p>Node.js:</p>
<pre class="highlight"><code class="language-js">const querystring = require(&quot;querystring&quot;);
console.log(querystring.stringify({ param: &quot; !$&amp;'()*+,;=-._~&quot; }));
console.log(querystring.parse(&quot;param=a+b&quot;).param);
</code></pre>

<pre class="highlight"><code class="language-text">param=%20!%24%26'()*%2B%2C%3B%3D-._~
a b
</code></pre>

<p>C#:</p>
<pre class="highlight"><code class="language-cs">using System;

class Program
{
    static void Main()
    {
        Console.WriteLine(System.Net.WebUtility.UrlEncode(&quot; !$&amp;'()*+,;=-._~&quot;));
        Console.WriteLine(System.Net.WebUtility.UrlDecode(&quot;a+b&quot;));
    }
}
</code></pre>

<pre class="highlight"><code class="language-text">+!%24%26%27()*%2B%2C%3B%3D-._%7E
a b
</code></pre>

<p>PHP:</p>
<pre class="highlight"><code class="language-php">&lt;?php
echo urlencode(&quot; !$&amp;'()*+,;=-._~&quot;) . &quot;\n&quot;;
echo urldecode(&quot;a+b&quot;) . &quot;\n&quot;;
echo rawurlencode(&quot; !$&amp;'()*+,;=-._~&quot;) . &quot;\n&quot;;
echo rawurldecode(&quot;a+b&quot;) . &quot;\n&quot;;
?&gt;
</code></pre>

<pre class="highlight"><code class="language-text">+%21%24%26%27%28%29%2A%2B%2C%3B%3D-._%7E
a b
%20%21%24%26%27%28%29%2A%2B%2C%3B%3D-._~
a+b
</code></pre>
    </div>
  </article>
  
<div class="article discuss-thread" id="discuss-thread">
  <h2>评论</h2>
  <!-- Disqus Begin -->
<div id="disqus_thread"></div>
<script>
  /**
   * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
   */
  var disqus_config = function () {
    this.page.url = "https://xiaohei.moe/post/2023/08/07/url-encode-differentiation/"; // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = "/post/2023/08/07/url-encode-differentiation/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  (function () { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//xiaohei-terminal.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
    powered by Disqus.</a></noscript>
<!-- Disqus end -->
</div>

</main>

  </div>

  
<footer class="footer" id="hitokoto">
  <p>己所不欲，勿施于人</p>
  
  
  
  
  
  
  
  
  
  
  
  <script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto%3Ep&c=a&c=d&c=i&c=k"></script>
</footer>

  <footer class="footer" id="footer">
    <p><a href="https://icp.gov.moe/?keyword=20230963" target="_blank">萌ICP备20230963号</a></p>
<p>&copy; 2022-2023 Xiaohei. All rights reserved.</p>
<p>Modified from <a href="https://github.com/verilab/purepress">PurePress</a> and <a
    href="https://github.com/verilab/purepress-theme-minimal">Minimal</a>.</p>
  </footer>

  

  <script>
  let elems = document.getElementsByTagName("a");
  for (let i = 0; i < elems.length; i++) {
    if (elems[i].href.indexOf(document.domain) < 0) {
      elems[i].target = "_blank";
    }
  }
</script>
  
<script>
  // enable code syntax highlight
  hljs.configure({ languages: [] }); // disable language auto detection
  hljs.initHighlightingOnLoad();

  // enable medium-zoom for all images
  mediumZoom(document.querySelectorAll('.content img'));
</script>

</body>

</html>